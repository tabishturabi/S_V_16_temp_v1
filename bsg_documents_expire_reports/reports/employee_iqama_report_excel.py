from odoo import models
from datetime import datetime
from odoo.exceptions import UserError,ValidationError
import xlsxwriter
import collections, functools, operator
from collections import OrderedDict
from ummalqura.hijri_date import HijriDate


class EmployeeIqamaReportExcel(models.AbstractModel):
    _name = 'report.bsg_documents_expire_reports.employee_iqama_report_xlsx'
    _inherit ='report.report_xlsx.abstract'


    def generate_xlsx_report(self, workbook,lines,data=None):
        main_heading = workbook.add_format({
            "bold": 0,
            "border": 1,
            "align": 'center',
            "valign": 'vcenter',
            "font_color": 'black',
            "bg_color": 'white',
            'font_size': '10',
        })
        main_heading2 = workbook.add_format({
            "bold": 1,
            "border": 1,
            "align": 'left',
            "valign": 'vcenter',
            "font_color": 'black',
            "bg_color": '#acadb2',
            'font_size': '12',
        })
        sheet = workbook.add_worksheet('Employees Iqama Report')
        # sheet.set_column('A2:A2',30)
        sheet.set_column('A:Q',20)
        row=0
        col=0
        if data.mode == 'all':
            if data.grouping_by == 'all':
                sheet.write(row, col, 'Employee ID', main_heading2)
                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                sheet.write(row, col + 2, 'Department Name', main_heading2)
                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                sheet.write(row, col + 4, 'Company Name', main_heading2)
                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                sheet.write(row, col + 11, 'Job Position', main_heading2)
                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                row += 1
                sheet.write(row, col, 'كود الموظف', main_heading2)
                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                row += 1
                if data.employee_state == 'all':
                    employee_ids = self.env['hr.employee'].search([])
                else:
                    employee_ids = self.env['hr.employee'].search([('employee_state', '=', data.employee_state)])
                for employee_id in employee_ids:
                    if employee_id:
                        if data.expire_date_condition == 'all':
                            iqama_id = self.env['hr.iqama'].search([('bsg_employee', '=', employee_id.id)])                          
                        if data.expire_date_condition == 'is_equal_to':
                            iqama_id = self.env['hr.iqama'].search([('bsg_employee', '=', employee_id.id), (
                                'bsg_expirydate', '=', data.expiry_date)])                          
                        if data.expire_date_condition == 'is_not_equal_to':
                            iqama_id = self.env['hr.iqama'].search([('bsg_employee', '=', employee_id.id), (
                                'bsg_expirydate', '!=', data.expiry_date)])                            
                        if data.expire_date_condition == 'is_after':
                            iqama_id = self.env['hr.iqama'].search([('bsg_employee', '=', employee_id.id), (
                                'bsg_expirydate', '>', data.expiry_date)])                           
                        if data.expire_date_condition == 'is_before':
                            iqama_id = self.env['hr.iqama'].search([('bsg_employee', '=', employee_id.id), (
                                'bsg_expirydate', '<', data.expiry_date)])                            
                        if data.expire_date_condition == 'is_after_or_equal_to':
                            iqama_id = self.env['hr.iqama'].search([('bsg_employee', '=', employee_id.id), (
                                'bsg_expirydate', '>=', data.expiry_date)])                          
                        if data.expire_date_condition == 'is_before_or_equal_to':
                            iqama_id = self.env['hr.iqama'].search([('bsg_employee', '=', employee_id.id), (
                                'bsg_expirydate', '<=', data.expiry_date)])                          
                        if data.expire_date_condition == 'is_between':
                            iqama_id = self.env['hr.iqama'].search([('bsg_employee', '=', employee_id.id),
                                                                    ('bsg_expirydate', '>', data.date_from),
                                                                    ('bsg_expirydate', '<', data.date_to)])                           
                        if data.expire_date_condition == 'is_set':
                            iqama_id = self.env['hr.iqama'].search(
                                [('bsg_employee', '=', employee_id.id), ('bsg_expirydate', '=', data.expiry_date)])
                        if data.expire_date_condition == 'is_not_set':
                            iqama_id = self.env['hr.iqama'].search([('bsg_employee', '=', employee_id.id), (
                                'bsg_expirydate', '=', data.expiry_date)])
                        for iqama in iqama_id:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
            if data.grouping_by == 'specific_guarantor':
                guarantor_ids = self.env['bsg.hr.guarantor'].search([])
                grand_total=0
                for guarantor_id in guarantor_ids:
                    if guarantor_id:
                        if data.expire_date_condition == 'all':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])                           
                        if data.expire_date_condition == 'is_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_expirydate', '=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                                 ('bsg_expirydate', '=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                         ('bsg_expirydate', '=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                           ('bsg_expirydate', '=', data.expiry_date)])             
                        if data.expire_date_condition == 'is_not_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                           ('bsg_expirydate', '!=', data.expiry_date)])                           
                        if data.expire_date_condition == 'is_after':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                                 ('bsg_expirydate', '>', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                           ('bsg_expirydate', '>', data.expiry_date)])                           
                        if data.expire_date_condition == 'is_before':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                                 ('bsg_expirydate', '<', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                           ('bsg_expirydate', '<', data.expiry_date)])                           
                        if data.expire_date_condition == 'is_after_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                           ('bsg_expirydate', '>=', data.expiry_date)])                           
                        if data.expire_date_condition == 'is_before_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                           ('bsg_expirydate', '<=', data.expiry_date)])                          
                        if data.expire_date_condition == 'is_between':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)
                                                                         ])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                                 ('bsg_expirydate', '<', data.date_to)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)
                                                                         ])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                           ('bsg_employee.employee_state', '=',data.employee_state),
                                                                           ('bsg_expirydate', '>', data.date_from),
                                                                           ('bsg_expirydate', '<', data.date_to)
                                                                           ])                           
                        if data.expire_date_condition == 'is_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_expirydate', '!=', None)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                                 ('bsg_expirydate', '!=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                         ('bsg_expirydate', '!=', None)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                           ('bsg_expirydate', '!=', None)])
                        if data.expire_date_condition == 'is_not_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_expirydate', '=', None)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                                 ('bsg_expirydate', '=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                         ('bsg_expirydate', '=', None)])
                                iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', guarantor_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                           ('bsg_expirydate', '=', None)])
                        grand_total += iqama_count
                        if iqama_ids:
                            sheet.write(row, col, 'Guarantor Name', main_heading2)
                            sheet.write_string(row, col + 1, str(guarantor_id.name), main_heading)
                            sheet.write(row, col+2, 'اسم الضامن', main_heading2)
                            row += 1
                            sheet.write(row, col, 'Employee ID', main_heading2)
                            sheet.write(row, col + 1, 'Employee Name', main_heading2)
                            sheet.write(row, col + 2, 'Department Name', main_heading2)
                            sheet.write(row, col + 3, 'Branch Name', main_heading2)
                            sheet.write(row, col + 4, 'Company Name', main_heading2)
                            sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                            sheet.write(row, col + 6, 'Issue Date', main_heading2)
                            sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                            sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                            sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                            sheet.write(row, col + 10, 'Job Position', main_heading2)
                            sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                            sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                            sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                            sheet.write(row, col + 14, 'Blood Group', main_heading2)
                            row += 1
                            sheet.write(row, col, 'هوية الموظف', main_heading2)
                            sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                            sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                            sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                            sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                            sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                            sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                            sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                            sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                            sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                            sheet.write(row, col + 10, 'وظيفه', main_heading2)
                            sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                            sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                            sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                            sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                            row += 1
                            for iqama in iqama_ids:
                                if iqama:
                                    if iqama.bsg_issuedate:
                                        issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                        # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                        # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                        issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                    else:
                                        issue_date_hijri_str = None
                                        issue_date_gregorian = None
                                    if iqama.bsg_arrivaldate:
                                        arrival_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_arrivaldate)
                                        # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                        # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                        arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                    else:
                                        arrival_date_hijri_str = None
                                        arrival_date_gregorian = None
                                    if iqama.bsg_expirydate:
                                        expiry_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_expirydate)
                                        # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                        # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                        expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                    else:
                                        expiry_date_hijri_str = None
                                        expiry_date_gregorian = None
                                    sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                       main_heading)
                                    sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 3, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                       main_heading)                                
                                    sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                    sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                    sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                    sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                       main_heading)
                                    sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                       main_heading)
                                    row += 1
                            sheet.write(row, col, 'Total', main_heading2)
                            sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                            row += 2
                if data.expire_date_condition == 'all':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])                  
                if data.expire_date_condition == 'is_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_expirydate', '=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_expirydate', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state),
                                                                 ('bsg_expirydate', '=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '=', data.expiry_date)])
                if data.expire_date_condition == 'is_not_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state),
                                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                if data.expire_date_condition == 'is_after':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state),
                                                                 ('bsg_expirydate', '>', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                if data.expire_date_condition == 'is_before':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_expirydate', '<', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state),
                                                                 ('bsg_expirydate', '<', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                if data.expire_date_condition == 'is_after_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state),
                                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                if data.expire_date_condition == 'is_before_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state),
                                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=',None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                if data.expire_date_condition == 'is_between':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                 ('bsg_expirydate', '<', data.date_to)
                                                                 ])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state),
                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                 ('bsg_expirydate', '<', data.date_to)
                                                                 ])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)
                                                                         ])
                if data.expire_date_condition == 'is_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_expirydate', '!=', None)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_expirydate', '!=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state),
                                                                 ('bsg_expirydate', '!=', None)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '!=', None)])
                if data.expire_date_condition == 'is_not_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_expirydate', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_expirydate', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('guarantor_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state),
                                                                 ('bsg_expirydate', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count([('guarantor_id', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '=', None)])
                grand_total += iqama_count
                if iqama_ids:
                    sheet.write(row, col, 'Guarantor Name', main_heading2)
                    sheet.write_string(row, col + 1, 'Undefined', main_heading)
                    sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                    row += 1
                    sheet.write(row, col, 'Employee ID', main_heading2)
                    sheet.write(row, col + 1, 'Employee Name', main_heading2)
                    sheet.write(row, col + 2, 'Department Name', main_heading2)
                    sheet.write(row, col + 3, 'Branch Name', main_heading2)
                    sheet.write(row, col + 4, 'Company Name', main_heading2)
                    sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                    sheet.write(row, col + 6, 'Issue Date', main_heading2)
                    sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                    sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                    sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                    sheet.write(row, col + 10, 'Job Position', main_heading2)
                    sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                    sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                    sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                    sheet.write(row, col + 14, 'Blood Group', main_heading2)
                    row += 1
                    sheet.write(row, col, 'هوية الموظف', main_heading2)
                    sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                    sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                    sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                    sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                    sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                    sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                    sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                    sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                    sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                    sheet.write(row, col + 10, 'وظيفه', main_heading2)
                    sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                    sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                    sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                    sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                    row += 1
                    for iqama in iqama_ids:
                        if iqama:
                            if iqama.bsg_issuedate:
                                issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                            else:
                                issue_date_hijri_str = None
                                issue_date_gregorian = None
                            if iqama.bsg_arrivaldate:
                                arrival_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_arrivaldate)
                                # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                            else:
                                arrival_date_hijri_str = None
                                arrival_date_gregorian = None
                            if iqama.bsg_expirydate:
                                expiry_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_expirydate)
                                # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                            else:
                                expiry_date_hijri_str = None
                                expiry_date_gregorian = None
                            sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                               main_heading)
                            sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                               main_heading)
                            sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                               main_heading)
                            sheet.write_string(row, col + 3, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                               main_heading)
                            sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                               main_heading)
                            sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                               main_heading)
                            sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                            sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                            sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                               main_heading)
                            sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                               main_heading)
                            sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                            sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                               main_heading)
                            sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                               main_heading)
                            sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                               main_heading)
                            sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                               main_heading)
                            row += 1
                    sheet.write(row, col, 'Total', main_heading2)
                    sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                    row += 2
                sheet.write(row, col, 'Grand Total', main_heading2)
                sheet.write_string(row, col + 1, str(grand_total),
                                   main_heading)
            if data.grouping_by == 'by_branch':
                branch_ids = self.env['bsg_branches.bsg_branches'].search([])
                grand_total = 0
                for branch_id in branch_ids:
                    if branch_id:
                        if data.expire_date_condition == 'all':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','=',branch_id.id)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.branch_id','=',branch_id.id)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','=',branch_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.branch_id','=',branch_id.id),
                                                                           ('bsg_employee.employee_state', '=',data.employee_state)])                           
                        if data.expire_date_condition == 'is_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','=',branch_id.id),
                                                                         ('bsg_expirydate', '=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.branch_id','=',branch_id.id),
                                                                                 ('bsg_expirydate', '=',data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=',branch_id.id),
                                                                         ('bsg_expirydate', '=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.branch_id', '=',branch_id.id),
                                                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                                                 ('bsg_employee.employee_state', '=', data.employee_state)])         
                        if data.expire_date_condition == 'is_not_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '!=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '!=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '!=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_before':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '<', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '<', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '<', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_after':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '>', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '>', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '>', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_after_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '>=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '>=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '>=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_before_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '<=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '<=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '<=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_between':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '>', data.date_from),
                                     ('bsg_expirydate', '<', data.date_to)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '>', data.date_from),
                                     ('bsg_expirydate', '<', data.date_to),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '!=', None)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '!=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '!=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '!=', None),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_not_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '=', None)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', branch_id.id),
                                                                         ('bsg_expirydate', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.branch_id', '=', branch_id.id),
                                     ('bsg_expirydate', '=', None),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        grand_total += iqama_count
                        if iqama_ids:
                            sheet.write(row, col, 'Branch Name', main_heading2)
                            sheet.write_string(row, col + 1, str(branch_id.branch_ar_name), main_heading)
                            sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                            row += 1
                            sheet.write(row, col, 'Employee ID', main_heading2)
                            sheet.write(row, col + 1, 'Employee Name', main_heading2)
                            sheet.write(row, col + 2, 'Department Name', main_heading2)
                            sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                            sheet.write(row, col + 4, 'Company Name', main_heading2)
                            sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                            sheet.write(row, col + 6, 'Issue Date', main_heading2)
                            sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                            sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                            sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                            sheet.write(row, col + 10, 'Job Position', main_heading2)
                            sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                            sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                            sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                            sheet.write(row, col + 14, 'Blood Group', main_heading2)
                            row += 1
                            sheet.write(row, col, 'هوية الموظف', main_heading2)
                            sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                            sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                            sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                            sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                            sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                            sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                            sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                            sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                            sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                            sheet.write(row, col + 10, 'وظيفه', main_heading2)
                            sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                            sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                            sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                            sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                            row += 1
                            for iqama in iqama_ids:
                                if iqama:
                                    if iqama.bsg_issuedate:
                                        issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                        # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                        # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                        issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                    else:
                                        issue_date_hijri_str = None
                                        issue_date_gregorian = None
                                    if iqama.bsg_arrivaldate:
                                        arrival_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_arrivaldate)
                                        # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                        # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                        arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                    else:
                                        arrival_date_hijri_str = None
                                        arrival_date_gregorian = None
                                    if iqama.bsg_expirydate:
                                        expiry_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_expirydate)
                                        # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                        # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                        expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                    else:
                                        expiry_date_hijri_str = None
                                        expiry_date_gregorian = None
                                    sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                       main_heading)
                                    sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                    sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                    sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                    sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                       main_heading)
                                    sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                       main_heading)
                                    row += 1
                            sheet.write(row, col, 'Total', main_heading2)
                            sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                            row += 2
                if data.expire_date_condition == 'all':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=',None)])
                        iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.branch_id', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.branch_id', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                if data.expire_date_condition == 'is_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=',None),
                                                                 ('bsg_expirydate', '=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.branch_id', '=', None),
                                                                         ('bsg_expirydate', '=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.branch_id', '=', None),
                                                                         ('bsg_expirydate', '=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                if data.expire_date_condition == 'is_not_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '!=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '!=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '!=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_before':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '<', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '<', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '<', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=',None),
                             ('bsg_expirydate', '<', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_after':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=',None),
                             ('bsg_expirydate', '>', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=',None),
                                                                 ('bsg_expirydate', '>', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '>', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_after_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '>=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=',None),
                                                                 ('bsg_expirydate', '>=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=',None),
                             ('bsg_expirydate', '>=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_before_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '<=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=',None),
                                                                 ('bsg_expirydate', '<=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '<=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_between':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                 ('bsg_expirydate', '<', data.date_to)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=',None),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=',None),
                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                 ('bsg_expirydate', '<', data.date_to),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '!=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '!=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=',None),
                                                                 ('bsg_expirydate', '!=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=',None),
                             ('bsg_expirydate', '!=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_not_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', '=', None),
                                                                 ('bsg_expirydate', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.branch_id', '=', None),
                             ('bsg_expirydate', '=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                grand_total += iqama_count
                if iqama_ids:
                    sheet.write(row, col, 'Branch Name', main_heading2)
                    sheet.write_string(row, col + 1, 'Undefined', main_heading)
                    sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                    row += 1
                    sheet.write(row, col, 'Employee ID', main_heading2)
                    sheet.write(row, col + 1, 'Employee Name', main_heading2)
                    sheet.write(row, col + 2, 'Department Name', main_heading2)
                    sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                    sheet.write(row, col + 4, 'Company Name', main_heading2)
                    sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                    sheet.write(row, col + 6, 'Issue Date', main_heading2)
                    sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                    sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                    sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                    sheet.write(row, col + 10, 'Job Position', main_heading2)
                    sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                    sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                    sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                    sheet.write(row, col + 14, 'Blood Group', main_heading2)
                    row += 1
                    sheet.write(row, col, 'هوية الموظف', main_heading2)
                    sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                    sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                    sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                    sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                    sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                    sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                    sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                    sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                    sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                    sheet.write(row, col + 10, 'وظيفه', main_heading2)
                    sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                    sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                    sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                    sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                    row += 1
                    for iqama in iqama_ids:
                        if iqama:
                            if iqama.bsg_issuedate:
                                issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                            else:
                                issue_date_hijri_str = None
                                issue_date_gregorian = None
                            if iqama.bsg_arrivaldate:
                                arrival_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_arrivaldate)
                                # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                            else:
                                arrival_date_hijri_str = None
                                arrival_date_gregorian = None
                            if iqama.bsg_expirydate:
                                expiry_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_expirydate)
                                # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                            else:
                                expiry_date_hijri_str = None
                                expiry_date_gregorian = None
                            sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                               main_heading)
                            sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                               main_heading)
                            sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                               main_heading)
                            sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                               main_heading)
                            sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                               main_heading)
                            sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                               main_heading)
                            sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                            sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                            sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                               main_heading)
                            sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                               main_heading)
                            sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                            sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                               main_heading)
                            sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                               main_heading)
                            sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                               main_heading)
                            sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                               main_heading)
                            row += 1
                    sheet.write(row, col, 'Total', main_heading2)
                    sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                    row += 2
                sheet.write(row, col, 'Grand Total', main_heading2)
                sheet.write_string(row, col + 1, str(grand_total),
                                   main_heading)
            if data.grouping_by == 'by_department':
                department_ids = self.env['hr.department'].search([])
                grand_total = 0
                for department_id in department_ids:
                    if department_id:
                        if data.expire_date_condition == 'all':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','=',department_id.id)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.department_id','=',department_id.id)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','=',department_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.department_id','=',department_id.id),
                                                                           ('bsg_employee.employee_state', '=',data.employee_state)])
                        if data.expire_date_condition == 'is_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','=',department_id.id),
                                                                         ('bsg_expirydate', '=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.department_id','=',department_id.id),
                                                                                 ('bsg_expirydate', '=',data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','=',department_id.id),
                                                                         ('bsg_expirydate', '=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.department_id','=',department_id.id),
                                                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_not_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '!=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '!=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '!=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])                            
                        if data.expire_date_condition == 'is_before':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '<', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '<', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '<', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_after':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '>', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '>', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '>', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_after_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '>=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '>=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '>=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_before_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '<=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '<=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '<=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_between':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '>', data.date_from),
                                     ('bsg_expirydate', '<', data.date_to)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '>', data.date_from),
                                     ('bsg_expirydate', '<', data.date_to),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '!=', None)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '!=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '!=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '!=', None),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_not_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '=', None)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', department_id.id),
                                                                         ('bsg_expirydate', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.department_id', '=', department_id.id),
                                     ('bsg_expirydate', '=', None),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        grand_total += iqama_count
                        if iqama_ids:
                            sheet.write(row, col, 'Department Name', main_heading2)
                            sheet.write_string(row, col + 1, str(department_id.complete_name), main_heading)
                            sheet.write(row, col+2, 'اسم القسم', main_heading2)
                            row += 1
                            sheet.write(row, col, 'Employee ID', main_heading2)
                            sheet.write(row, col + 1, 'Employee Name', main_heading2)
                            sheet.write(row, col + 2, 'Branch Name', main_heading2)
                            sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                            sheet.write(row, col + 4, 'Company Name', main_heading2)
                            sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                            sheet.write(row, col + 6, 'Issue Date', main_heading2)
                            sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                            sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                            sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                            sheet.write(row, col + 10, 'Job Position', main_heading2)
                            sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                            sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                            sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                            sheet.write(row, col + 14, 'Blood Group', main_heading2)
                            row += 1
                            sheet.write(row, col, 'هوية الموظف', main_heading2)
                            sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                            sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                            sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                            sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                            sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                            sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                            sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                            sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                            sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                            sheet.write(row, col + 10, 'وظيفه', main_heading2)
                            sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                            sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                            sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                            sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                            row += 1
                            for iqama in iqama_ids:
                                if iqama:
                                    if iqama.bsg_issuedate:
                                        issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                        # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                        # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                        issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                    else:
                                        issue_date_hijri_str = None
                                        issue_date_gregorian = None
                                    if iqama.bsg_arrivaldate:
                                        arrival_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_arrivaldate)
                                        # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                        # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                        arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                    else:
                                        arrival_date_hijri_str = None
                                        arrival_date_gregorian = None
                                    if iqama.bsg_expirydate:
                                        expiry_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_expirydate)
                                        # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                        # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                        expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                    else:
                                        expiry_date_hijri_str = None
                                        expiry_date_gregorian = None
                                    sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                       main_heading)
                                    sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 2, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                    sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                    sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                    sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                       main_heading)
                                    sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                       main_heading)
                                    row += 1
                            sheet.write(row, col, 'Total', main_heading2)
                            sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                            row += 2
                if data.expire_date_condition == 'all':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=',None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=',None),
                             ('bsg_expirydate', '=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_not_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '!=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '!=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '!=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_before':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '<', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '<', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '<', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '<', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_after':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '>', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '>', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_after_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '>=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '>=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '>=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_before_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '<=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=',None),
                                                                 ('bsg_expirydate', '<=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '<=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_between':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=',None),
                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                 ('bsg_expirydate', '<', data.date_to)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                 ('bsg_expirydate', '<', data.date_to),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '!=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '!=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '!=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '!=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_not_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', '=', None),
                                                                 ('bsg_expirydate', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.department_id', '=', None),
                             ('bsg_expirydate', '=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                grand_total += iqama_count
                if iqama_ids:
                    sheet.write(row, col, 'Department Name', main_heading2)
                    sheet.write_string(row, col + 1, 'Undefined', main_heading)
                    sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                    row += 1
                    sheet.write(row, col, 'Employee ID', main_heading2)
                    sheet.write(row, col + 1, 'Employee Name', main_heading2)
                    sheet.write(row, col + 2, 'Branch Name', main_heading2)
                    sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                    sheet.write(row, col + 4, 'Company Name', main_heading2)
                    sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                    sheet.write(row, col + 6, 'Issue Date', main_heading2)
                    sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                    sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                    sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                    sheet.write(row, col + 10, 'Job Position', main_heading2)
                    sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                    sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                    sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                    sheet.write(row, col + 14, 'Blood Group', main_heading2)
                    row += 1
                    sheet.write(row, col, 'هوية الموظف', main_heading2)
                    sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                    sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                    sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                    sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                    sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                    sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                    sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                    sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                    sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                    sheet.write(row, col + 10, 'وظيفه', main_heading2)
                    sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                    sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                    sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                    sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                    row += 1
                    for iqama in iqama_ids:
                        if iqama:
                            if iqama.bsg_issuedate:
                                issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                            else:
                                issue_date_hijri_str = None
                                issue_date_gregorian = None
                            if iqama.bsg_arrivaldate:
                                arrival_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_arrivaldate)
                                # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                            else:
                                arrival_date_hijri_str = None
                                arrival_date_gregorian = None
                            if iqama.bsg_expirydate:
                                expiry_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_expirydate)
                                # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                            else:
                                expiry_date_hijri_str = None
                                expiry_date_gregorian = None
                            sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                               main_heading)
                            sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                               main_heading)
                            sheet.write_string(row, col + 2, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                               main_heading)
                            sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                               main_heading)
                            sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                               main_heading)
                            sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                               main_heading)
                            sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                            sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                            sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                               main_heading)
                            sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                               main_heading)
                            sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                            sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                               main_heading)
                            sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                               main_heading)
                            sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                               main_heading)
                            sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                               main_heading)
                            row += 1
                    sheet.write(row, col, 'Total', main_heading2)
                    sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                    row += 2
                sheet.write(row, col, 'Grand Total', main_heading2)
                sheet.write_string(row, col + 1, str(grand_total),main_heading)
            if data.grouping_by == 'by_company':
                company_ids = self.env['res.company'].search([])
                grand_total = 0
                for company_id in company_ids:
                    if company_id:
                        if data.expire_date_condition == 'all':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','=',company_id.id)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.company_id','=',company_id.id)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','=',company_id.id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.company_id','=',company_id.id),
                                                                           ('bsg_employee.employee_state', '=',data.employee_state)])
                        if data.expire_date_condition == 'is_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','=',company_id.id),
                                                                         ('bsg_expirydate', '=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.company_id','=',company_id.id),
                                                                                 ('bsg_expirydate', '=',data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','=',company_id.id),
                                                                         ('bsg_expirydate', '=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_employee.company_id','=',company_id.id),
                                                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_not_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '!=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '!=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '!=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])                          
                        if data.expire_date_condition == 'is_before':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '<', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '<', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '<', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_after':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '>', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '>', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '>', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])                         
                        if data.expire_date_condition == 'is_after_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '>=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '>=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '>=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_before_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '<=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '<=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '<=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_between':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '>', data.date_from),
                                     ('bsg_expirydate', '<', data.date_to)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '>', data.date_from),
                                     ('bsg_expirydate', '<', data.date_to),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '!=', None)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '!=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '!=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '!=', None),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_not_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '=', None)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', company_id.id),
                                                                         ('bsg_expirydate', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_employee.company_id', '=', company_id.id),
                                     ('bsg_expirydate', '=', None),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        grand_total += iqama_count
                        if iqama_ids:
                            sheet.write(row, col, 'Company Name', main_heading2)
                            sheet.write_string(row, col + 1, str(company_id.name), main_heading)
                            sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                            row += 1
                            sheet.write(row, col, 'Employee ID', main_heading2)
                            sheet.write(row, col + 1, 'Employee Name', main_heading2)
                            sheet.write(row, col + 2, 'Branch Name', main_heading2)
                            sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                            sheet.write(row, col + 4, 'Department Name', main_heading2)
                            sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                            sheet.write(row, col + 6, 'Issue Date', main_heading2)
                            sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                            sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                            sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                            sheet.write(row, col + 10, 'Job Position', main_heading2)
                            sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                            sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                            sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                            sheet.write(row, col + 14, 'Blood Group', main_heading2)
                            row += 1
                            sheet.write(row, col, 'هوية الموظف', main_heading2)
                            sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                            sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                            sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                            sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                            sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                            sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                            sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                            sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                            sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                            sheet.write(row, col + 10, 'وظيفه', main_heading2)
                            sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                            sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                            sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                            sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                            row += 1
                            for iqama in iqama_ids:
                                if iqama:
                                    if iqama.bsg_issuedate:
                                        issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                        # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                        # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                        issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                    else:
                                        issue_date_hijri_str = None
                                        issue_date_gregorian = None
                                    if iqama.bsg_arrivaldate:
                                        arrival_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_arrivaldate)
                                        # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                        # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                        arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                    else:
                                        arrival_date_hijri_str = None
                                        arrival_date_gregorian = None
                                    if iqama.bsg_expirydate:
                                        expiry_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_expirydate)
                                        # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                        # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                        expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                    else:
                                        expiry_date_hijri_str = None
                                        expiry_date_gregorian = None
                                    sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                       main_heading)
                                    sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 2,
                                                       str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                    sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                    sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                    sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                       main_heading)
                                    sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                       main_heading)
                                    row += 1
                            sheet.write(row, col, 'Total', main_heading2)
                            sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                            row += 2
                if data.expire_date_condition == 'all':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])                   
                if data.expire_date_condition == 'is_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_not_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '!=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '!=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '!=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_before':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '<', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '<', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '<', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '<', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_after':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '>', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '>', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_after_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '>=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '>=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '>=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_before_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '<=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '<=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '<=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_between':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                 ('bsg_expirydate', '<', data.date_to)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                 ('bsg_expirydate', '<', data.date_to),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '!=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '!=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '!=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '!=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_not_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', '=', None),
                                                                 ('bsg_expirydate', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.company_id', '=', None),
                             ('bsg_expirydate', '=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Company Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 4, 'Department Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                sheet.write(row, col, 'Grand Total', main_heading2)
                sheet.write_string(row, col + 1, str(grand_total),main_heading)
            if data.grouping_by == 'by_employee_tag':
                category_ids = self.env['hr.employee.category'].search([])
                employee_ids = self.env['hr.employee'].search([])
                grand_total = 0
                for category_id in category_ids:
                    if category_id:
                        iqama_list=[]
                        total=0
                        for employee_id in employee_ids:
                            if employee_id:
                                if category_id in employee_id.category_ids:
                                    if data.expire_date_condition == 'all':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if category_id in iqama.bsg_employee.category_ids:
                                                        iqama_list.append(iqama)
                                    if data.expire_date_condition == 'is_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if category_id in iqama.bsg_employee.category_ids:
                                                        iqama_list.append(iqama)
                                    if data.expire_date_condition == 'is_not_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '!=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=',
                                                  data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if category_id in iqama.bsg_employee.category_ids:
                                                        iqama_list.append(iqama)
                                    if data.expire_date_condition == 'is_before':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '<', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '<', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=',
                                                  data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if category_id in iqama.bsg_employee.category_ids:
                                                        iqama_list.append(iqama)
                                    if data.expire_date_condition == 'is_after':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '>', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '>', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=',
                                                  data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if category_id in iqama.bsg_employee.category_ids:
                                                        iqama_list.append(iqama)
                                    if data.expire_date_condition == 'is_after_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '>=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=',
                                                  data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if category_id in iqama.bsg_employee.category_ids:
                                                        iqama_list.append(iqama)
                                    if data.expire_date_condition == 'is_before_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '<=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=',
                                                  data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if category_id in iqama.bsg_employee.category_ids:
                                                        iqama_list.append(iqama)
                                    if data.expire_date_condition == 'is_between':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if category_id in iqama.bsg_employee.category_ids:
                                                        iqama_list.append(iqama)
                                    if data.expire_date_condition == 'is_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '!=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '!=', None),
                                                 ('bsg_employee.employee_state', '=',
                                                  data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if category_id in iqama.bsg_employee.category_ids:
                                                        iqama_list.append(iqama)
                                    if data.expire_date_condition == 'is_not_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee', '=', employee_id.id),
                                                 ('bsg_expirydate', '=', None),
                                                 ('bsg_employee.employee_state', '=',
                                                  data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if category_id in iqama.bsg_employee.category_ids:
                                                        iqama_list.append(iqama)
                        if iqama_list:
                            sheet.write(row, col, 'Employee Tag', main_heading2)
                            sheet.write_string(row, col + 1, str(category_id.name), main_heading)
                            sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                            row += 1
                            sheet.write(row, col, 'Employee ID', main_heading2)
                            sheet.write(row, col + 1, 'Employee Name', main_heading2)
                            sheet.write(row, col + 2, 'Department Name', main_heading2)
                            sheet.write(row, col + 3, 'Branch Name', main_heading2)
                            sheet.write(row, col + 4, 'Company Name', main_heading2)
                            sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                            sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                            sheet.write(row, col + 7, 'Issue Date', main_heading2)
                            sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                            sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                            sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                            sheet.write(row, col + 11, 'Job Position', main_heading2)
                            sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                            sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                            sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                            sheet.write(row, col + 15, 'Blood Group', main_heading2)
                            row += 1
                            sheet.write(row, col, 'كود الموظف', main_heading2)
                            sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                            sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                            sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                            sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                            sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                            sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                            sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                            sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                            sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                            sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                            sheet.write(row, col + 11, 'وظيفه', main_heading2)
                            sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                            sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                            sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                            sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                            row += 1
                            total = len(iqama_list)
                            grand_total+=total
                            for iqama in iqama_list:
                                if iqama:
                                    if iqama.bsg_issuedate:
                                        issue_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_issuedate)
                                        # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                        # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                        issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                    else:
                                        issue_date_hijri_str = None
                                        issue_date_gregorian = None
                                    if iqama.bsg_arrivaldate:
                                        arrival_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_arrivaldate)
                                        # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                        # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                        arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                            "%m/%d/%Y")
                                    else:
                                        arrival_date_hijri_str = None
                                        arrival_date_gregorian = None
                                    if iqama.bsg_expirydate:
                                        expiry_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_expirydate)
                                        # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                        # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                        expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                            "%m/%d/%Y")
                                    else:
                                        expiry_date_hijri_str = None
                                        expiry_date_gregorian = None
                                    sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                       main_heading)
                                    sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                       main_heading)
                                    sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                       main_heading)
                                    sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 3, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                    sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                    sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                    sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                       main_heading)
                                    sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                       main_heading)
                                    row += 1
                            sheet.write(row, col, 'Total', main_heading2)
                            sheet.write_string(row, col + 1, str(total), main_heading)
                            row += 2
                if data.expire_date_condition == 'all':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=',False)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_not_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '!=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '!=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '!=', data.expiry_date),
                             ('bsg_employee.employee_state', '=',
                              data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '!=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_before':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '<', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '<', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '<', data.expiry_date),
                             ('bsg_employee.employee_state', '=',
                              data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '<', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_after':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=',False),
                             ('bsg_expirydate', '>', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=',False),
                             ('bsg_expirydate', '>', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '>', data.expiry_date),
                             ('bsg_employee.employee_state', '=',
                              data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '>', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_after_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '>=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '>=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '>=', data.expiry_date),
                             ('bsg_employee.employee_state', '=',
                              data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '>=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_before_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '<=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '<=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=',False),
                             ('bsg_expirydate', '<=', data.expiry_date),
                             ('bsg_employee.employee_state', '=',
                              data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=',False),
                             ('bsg_expirydate', '<=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_between':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=',False),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '!=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '!=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '!=', None),
                             ('bsg_employee.employee_state', '=',
                              data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '!=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_not_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=',False),
                             ('bsg_expirydate', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=',False),
                             ('bsg_expirydate', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '=', None),
                             ('bsg_employee.employee_state', '=',
                              data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_employee.category_ids', '=', False),
                             ('bsg_expirydate', '=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                grand_total += iqama_count
                if iqama_ids:
                    sheet.write(row, col, 'Employee Tag', main_heading2)
                    sheet.write_string(row, col + 1, 'Undefined', main_heading)
                    sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                    row += 1
                    sheet.write(row, col, 'Employee ID', main_heading2)
                    sheet.write(row, col + 1, 'Employee Name', main_heading2)
                    sheet.write(row, col + 2, 'Department Name', main_heading2)
                    sheet.write(row, col + 3, 'Branch Name', main_heading2)
                    sheet.write(row, col + 4, 'Company Name', main_heading2)
                    sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                    sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                    sheet.write(row, col + 7, 'Issue Date', main_heading2)
                    sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                    sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                    sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                    sheet.write(row, col + 11, 'Job Position', main_heading2)
                    sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                    sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                    sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                    sheet.write(row, col + 15, 'Blood Group', main_heading2)
                    row += 1
                    sheet.write(row, col, 'كود الموظف', main_heading2)
                    sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                    sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                    sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                    sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                    sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                    sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                    sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                    sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                    sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                    sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                    sheet.write(row, col + 11, 'وظيفه', main_heading2)
                    sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                    sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                    sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                    sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                    row += 1
                    for iqama in iqama_ids:
                        if iqama:
                            if iqama.bsg_issuedate:
                                issue_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_issuedate)
                                # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                            else:
                                issue_date_hijri_str = None
                                issue_date_gregorian = None
                            if iqama.bsg_arrivaldate:
                                arrival_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_arrivaldate)
                                # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                    "%m/%d/%Y")
                            else:
                                arrival_date_hijri_str = None
                                arrival_date_gregorian = None
                            if iqama.bsg_expirydate:
                                expiry_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_expirydate)
                                # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                    "%m/%d/%Y")
                            else:
                                expiry_date_hijri_str = None
                                expiry_date_gregorian = None
                            sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                               main_heading)
                            sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                               main_heading)
                            sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                               main_heading)
                            sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                               main_heading)
                            sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                               main_heading)
                            sheet.write_string(row, col + 3, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                               main_heading)
                            sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                               main_heading)
                            sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                               main_heading)
                            sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                               main_heading)
                            sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                            sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                            sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                               main_heading)
                            sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                               main_heading)
                            sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                            sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                               main_heading)
                            sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                               main_heading)
                            sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                               main_heading)
                            sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                               main_heading)
                            row += 1
                    sheet.write(row, col, 'Total', main_heading2)
                    sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                    row += 2
                sheet.write(row, col, 'Grand Total', main_heading2)
                sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_job_position':
                job_ids=[]
                iqamas = self.env['hr.iqama'].search([])
                for iq in iqamas:
                    if iq.bsg_job_pos:
                        job_ids.append(iq.bsg_job_pos)
                job_ids=list(set(job_ids))
                grand_total = 0
                for job_id in job_ids:
                    if job_id:
                        if data.expire_date_condition == 'all':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_job_pos','=',job_id)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_job_pos','=',job_id),
                                                                           ('bsg_employee.employee_state', '=',data.employee_state)])
                        if data.expire_date_condition == 'is_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count([('bsg_job_pos','=',job_id),
                                                                                 ('bsg_expirydate', '=',data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', job_id),
                                                                         ('bsg_expirydate', '=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos', '=', job_id),
                                     ('bsg_expirydate', '=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_not_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '!=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '!=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '!=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '!=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_before':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '<', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '<', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '<', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_after':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '>', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '>', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '>', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_after_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '>=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '>=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '>=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_before_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '<=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '<=', data.expiry_date),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '<=', data.expiry_date),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_between':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '>', data.date_from),
                                     ('bsg_expirydate', '<', data.date_to)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '>', data.date_from),
                                     ('bsg_expirydate', '<', data.date_to),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '!=', None)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '!=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '!=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '!=', None),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        if data.expire_date_condition == 'is_not_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '=', None)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos','=',job_id),
                                                                         ('bsg_expirydate', '=', None),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state)])
                                iqama_count = self.env['hr.iqama'].search_count(
                                    [('bsg_job_pos','=',job_id),
                                     ('bsg_expirydate', '=', None),
                                     ('bsg_employee.employee_state', '=', data.employee_state)])
                        grand_total += iqama_count
                        if iqama_ids:
                            sheet.write(row, col, 'Job Position', main_heading2)
                            sheet.write_string(row, col + 1, str(job_id), main_heading)
                            sheet.write(row, col + 2, 'وظيفه', main_heading2)
                            row += 1
                            sheet.write(row, col, 'Employee ID', main_heading2)
                            sheet.write(row, col + 1, 'Employee Name', main_heading2)
                            sheet.write(row, col + 2, 'Branch Name', main_heading2)
                            sheet.write(row, col + 3, 'Department Name', main_heading2)
                            sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                            sheet.write(row, col + 5, 'Company Name', main_heading2)
                            sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                            sheet.write(row, col + 7, 'Issue Date', main_heading2)
                            sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                            sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                            sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                            sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                            sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                            sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                            sheet.write(row, col + 14, 'Blood Group', main_heading2)
                            row += 1
                            sheet.write(row, col, 'هوية الموظف', main_heading2)
                            sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                            sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                            sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                            sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                            sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                            sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                            sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                            sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                            sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                            sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                            sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                            sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                            sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                            sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                            row += 1
                            for iqama in iqama_ids:
                                if iqama:
                                    if iqama.bsg_issuedate:
                                        issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                        # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                        # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                        issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                    else:
                                        issue_date_hijri_str = None
                                        issue_date_gregorian = None
                                    if iqama.bsg_arrivaldate:
                                        arrival_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_arrivaldate)
                                        # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                        # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                        arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                    else:
                                        arrival_date_hijri_str = None
                                        arrival_date_gregorian = None
                                    if iqama.bsg_expirydate:
                                        expiry_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_expirydate)
                                        # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                        # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                        expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                    else:
                                        expiry_date_hijri_str = None
                                        expiry_date_gregorian = None
                                    sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                       main_heading)
                                    sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 2,
                                                       str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                    sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                    sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                       main_heading)
                                    sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                       main_heading)
                                    row += 1
                            sheet.write(row, col, 'Total', main_heading2)
                            sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                            row += 2
                if data.expire_date_condition == 'all':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=',None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=',None),
                             ('bsg_expirydate', '=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_not_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '!=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '!=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '!=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_before':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '<', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '<', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '<', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '<', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_after':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '>', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '>', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '>', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '>', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_after_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '>=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '>=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '>=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_before_or_equal_to':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '<=', data.expiry_date)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=',None),
                                                                 ('bsg_expirydate', '<=', data.expiry_date),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '<=', data.expiry_date),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_between':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=',None),
                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                 ('bsg_expirydate', '<', data.date_to)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '>', data.date_from),
                                                                 ('bsg_expirydate', '<', data.date_to),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '>', data.date_from),
                             ('bsg_expirydate', '<', data.date_to),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '!=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '!=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '!=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '!=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                if data.expire_date_condition == 'is_not_set':
                    if data.employee_state == 'all':
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '=', None)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '=', None)])
                    else:
                        iqama_ids = self.env['hr.iqama'].search([('bsg_job_pos', '=', None),
                                                                 ('bsg_expirydate', '=', None),
                                                                 ('bsg_employee.employee_state', '=',
                                                                  data.employee_state)])
                        iqama_count = self.env['hr.iqama'].search_count(
                            [('bsg_job_pos', '=', None),
                             ('bsg_expirydate', '=', None),
                             ('bsg_employee.employee_state', '=', data.employee_state)])
                grand_total += iqama_count
                if iqama_ids:
                    sheet.write(row, col, 'Job Position', main_heading2)
                    sheet.write_string(row, col + 1, 'Undefined', main_heading)
                    sheet.write(row, col + 2, 'وظيفه', main_heading2)
                    row += 1
                    sheet.write(row, col, 'Employee ID', main_heading2)
                    sheet.write(row, col + 1, 'Employee Name', main_heading2)
                    sheet.write(row, col + 2, 'Branch Name', main_heading2)
                    sheet.write(row, col + 3, 'Department Name', main_heading2)
                    sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                    sheet.write(row, col + 5, 'Company Name', main_heading2)
                    sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                    sheet.write(row, col + 7, 'Issue Date', main_heading2)
                    sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                    sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                    sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                    sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                    sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                    sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                    sheet.write(row, col + 14, 'Blood Group', main_heading2)
                    row += 1
                    sheet.write(row, col, 'هوية الموظف', main_heading2)
                    sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                    sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                    sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                    sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                    sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                    sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                    sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                    sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                    sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                    sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                    sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                    sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                    sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                    sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                    row += 1
                    for iqama in iqama_ids:
                        if iqama:
                            if iqama.bsg_issuedate:
                                issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                            else:
                                issue_date_hijri_str = None
                                issue_date_gregorian = None
                            if iqama.bsg_arrivaldate:
                                arrival_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_arrivaldate)
                                # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                            else:
                                arrival_date_hijri_str = None
                                arrival_date_gregorian = None
                            if iqama.bsg_expirydate:
                                expiry_date_hijri_str = HijriDate.get_hijri_date(
                                    iqama.bsg_expirydate)
                                # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                            else:
                                expiry_date_hijri_str = None
                                expiry_date_gregorian = None
                            sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                               main_heading)
                            sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                               main_heading)
                            sheet.write_string(row, col + 2,
                                               str(iqama.bsg_employee.branch_id.branch_ar_name),
                                               main_heading)
                            sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                               main_heading)
                            sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                               main_heading)
                            sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                               main_heading)
                            sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                               main_heading)
                            sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                            sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                            sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                               main_heading)
                            sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                               main_heading)
                            sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                               main_heading)
                            sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                               main_heading)
                            sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                               main_heading)
                            sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                               main_heading)
                            row += 1
                    sheet.write(row, col, 'Total', main_heading2)
                    sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                    row += 2
                sheet.write(row, col, 'Grand Total', main_heading2)
                sheet.write_string(row, col + 1, str(grand_total),main_heading)
        if data.mode == 'specific_guarantor':
            if data.grouping_by == 'all':
                sheet.write(row, col, 'Employee ID', main_heading2)
                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                sheet.write(row, col + 2, 'Department Name', main_heading2)
                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                sheet.write(row, col + 4, 'Company Name', main_heading2)
                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                sheet.write(row, col + 11, 'Job Position', main_heading2)
                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                row += 1
                sheet.write(row, col, 'كود الموظف', main_heading2)
                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                row += 1
                if data.guarantor:
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id','in',data.guarantor.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id','in',data.guarantor.ids),('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                     ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                     ('bsg_employee.employee_state', '=', data.employee_state),
                                                                     ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_expirydate', '!=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_expirydate', '=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '=', None)])
                    if iqama_ids:
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
            if data.grouping_by == 'specific_guarantor':
                if data.guarantor:
                    grand_total=0
                    for guarantor_id in data.guarantor:
                        if guarantor_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total += iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Guarantor Name', main_heading2)
                                sheet.write_string(row, col + 1, str(guarantor_id.name), main_heading)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Company Name', main_heading2)
                                sheet.write(row, col + 4, 'Department Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=',None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Guarantor Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Company Name', main_heading2)
                        sheet.write(row, col + 4, 'Department Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
                    row += 1
            if data.grouping_by == 'by_branch':
                if data.guarantor:
                    branch_ids = self.env['bsg_branches.bsg_branches'].search([])
                    grand_total=0
                    for branch_id in branch_ids:
                        if branch_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                           
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])                               
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])                              
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])                             
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total += iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Branch Name', main_heading2)
                                sheet.write_string(row, col + 1, str(branch_id.branch_ar_name), main_heading)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 3, 'Company Name', main_heading2)
                                sheet.write(row, col + 4, 'Department Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=',None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=',None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=',None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=',None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=',None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Branch Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 3, 'Company Name', main_heading2)
                        sheet.write(row, col + 4, 'Department Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
                    row += 1
            if data.grouping_by == 'by_department':
                if data.guarantor:
                    department_ids = self.env['hr.department'].search([])
                    grand_total=0
                    for department_id in department_ids:
                        if department_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Department Name', main_heading2)
                                sheet.write_string(row, col + 1, str(department_id.complete_name), main_heading)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 3, 'Company Name', main_heading2)
                                sheet.write(row, col + 4, 'Branch Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 4, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])                      
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=',None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Department Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 3, 'Company Name', main_heading2)
                        sheet.write(row, col + 4, 'Branch Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 4, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
                    row += 1
            if data.grouping_by == 'by_company':
                if data.guarantor:
                    company_ids = self.env['res.company'].search([])
                    grand_total = 0
                    for company_id in company_ids:
                        if company_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                               
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total += iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Company Name', main_heading2)
                                sheet.write_string(row, col + 1, str(company_id.name), main_heading)
                                sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 3, 'Departement Name', main_heading2)
                                sheet.write(row, col + 4, 'Branch Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 4, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row +=1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=',None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Company Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 3, 'Departement Name', main_heading2)
                        sheet.write(row, col + 4, 'Branch Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 4, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
                    row += 1
            if data.grouping_by == 'by_employee_tag':
                if data.guarantor:
                    category_ids = self.env['hr.employee.category'].search([])
                    grand_total = 0
                    for category_id in category_ids:
                        if category_id:
                            iqama_list=[]
                            total = 0
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                             ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                             ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                             ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                             ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                             ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                             ('bsg_expirydate', '>', data.date_from),
                                                                             ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                             ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                             ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if iqama_list:
                                sheet.write(row, col, 'Employee Tag', main_heading2)
                                sheet.write_string(row, col + 1, str(category_id.name), main_heading)
                                sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Department Name', main_heading2)
                                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 11, 'Job Position', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'كود الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_list:
                                    if iqama:
                                        total += 1
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                grand_total += total
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(total), main_heading)
                                row += 2
                    total=0
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.category_ids', '=', False),('guarantor_id', 'in', data.guarantor.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids), ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state),('bsg_employee.category_ids', '=', False)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                     ('bsg_employee.category_ids', '=', False),
                                                                     ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                     ('bsg_employee.category_ids', '=', False),
                                                                     ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                     ('bsg_employee.category_ids', '=', False),
                                                                     ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                     ('bsg_employee.category_ids', '=', False),
                                                                     ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                     ('bsg_employee.category_ids', '=', False),
                                                                     ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                     ('bsg_expirydate', '>', data.date_from),
                                                                     ('bsg_employee.category_ids', '=', False),
                                                                     ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                     ('bsg_employee.category_ids', '=', False),
                                                                     ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('guarantor_id', 'in', data.guarantor.ids),
                                                                     ('bsg_employee.category_ids', '=', False),
                                                                     ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if iqama_ids:
                        sheet.write(row, col, 'Employee Tag', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Department Name', main_heading2)
                        sheet.write(row, col + 3, 'Branch Name', main_heading2)
                        sheet.write(row, col + 4, 'Company Name', main_heading2)
                        sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date', main_heading2)
                        sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 11, 'Job Position', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 15, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'كود الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 11, 'وظيفه', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                total += 1
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        grand_total += total
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(total), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_job_position':
                if data.guarantor:
                    job_ids = []
                    iqamas = self.env['hr.iqama'].search([])
                    for iq in iqamas:
                        if iq.bsg_job_pos:
                            job_ids.append(iq.bsg_job_pos)
                    job_ids = list(set(job_ids))
                    grand_total=0
                    for job_id in job_ids:
                        if job_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=',job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=',job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=',job_id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=',job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', 'in', data.guarantor.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Job Position', main_heading2)
                                sheet.write_string(row, col + 1, str(job_id), main_heading)
                                sheet.write(row, col + 2, 'وظيفه', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Department Name', main_heading2)
                                sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 5, 'Company Name', main_heading2)
                                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])                      
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=',None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', 'in', data.guarantor.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Job Position', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'وظيفه', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Department Name', main_heading2)
                        sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 5, 'Company Name', main_heading2)
                        sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date', main_heading2)
                        sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
                    row += 1
        if data.mode == 'by_branch':
            if data.grouping_by == 'all':
                sheet.write(row, col, 'Employee ID', main_heading2)
                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                sheet.write(row, col + 2, 'Department Name', main_heading2)
                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                sheet.write(row, col + 4, 'Company Name', main_heading2)
                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                sheet.write(row, col + 11, 'Job Position', main_heading2)
                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                row += 1
                sheet.write(row, col, 'كود الموظف', main_heading2)
                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                row += 1
                if data.branches:
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                     ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                     ('bsg_employee.employee_state', '=', data.employee_state),
                                                                     ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                        ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                        ('bsg_employee.employee_state', '=',data.employee_state),                                                          
                                                                        ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                        ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                        ('bsg_employee.employee_state', '=',data.employee_state),                                                                        
                                                                        ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                        ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),                                                                        
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                        ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                        ('bsg_employee.employee_state', '=',data.employee_state),                                                                         
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),                                                                        
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                         ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),                                                                         
                                                                         ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                         ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id','in',data.branches.ids),
                                                                         ('bsg_employee.employee_state', '=',data.employee_state),                                                                         
                                                                         ('bsg_expirydate', '=', None)])
                    if iqama_ids:
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
            if data.grouping_by == 'specific_guarantor':
                if data.branches:
                    guarantor_ids = self.env['bsg.hr.guarantor'].search([])
                    grand_total=0
                    for guarantor_id in guarantor_ids:
                        if guarantor_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                               
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Guarantor Name', main_heading2)
                                sheet.write_string(row, col + 1, str(guarantor_id.name), main_heading)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Company Name', main_heading2)
                                sheet.write(row, col + 4, 'Department Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])                       
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Guarantor Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Company Name', main_heading2)
                        sheet.write(row, col + 4, 'Department Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_branch':
                if data.branches:
                    grand_total=0
                    for branch_id in data.branches:
                        if branch_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state)])                              
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Branch Name', main_heading2)
                                sheet.write_string(row, col + 1, str(branch_id.branch_ar_name), main_heading)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Department Name', main_heading2)
                                sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', branch_id.id),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Branch Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Department Name', main_heading2)
                        sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 4, 'Company Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_department':
                if data.branches:
                    department_ids = self.env['hr.department'].search([])
                    grand_total=0
                    for department_id in department_ids:
                        if department_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Department Name', main_heading2)
                                sheet.write_string(row, col + 1, str(department_id.complete_name), main_heading)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=',None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=',None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=',None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Department Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 4, 'Company Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_company':
                if data.branches:
                    company_ids = self.env['res.company'].search([])
                    grand_total = 0
                    for company_id in company_ids:
                        if company_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total += iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Company Name', main_heading2)
                                sheet.write_string(row, col + 1, str(company_id.name), main_heading)
                                sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 4, 'Department Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Company Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 4, 'Department Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col+ 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_employee_tag':
                if data.branches:
                    category_ids = self.env['hr.employee.category'].search([])
                    grand_total = 0
                    for category_id in category_ids:
                        if category_id:
                            iqama_list=[]
                            total = 0
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', 'in', data.branches.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', 'in', data.branches.ids),('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', 'in', data.branches.ids),
                                                                             ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                                
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', 'in', data.branches.ids),
                                                                             ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', 'in', data.branches.ids),
                                                                             ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                  
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', 'in', data.branches.ids),
                                                                             ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                    
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                                
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', 'in', data.branches.ids),
                                                                             ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', 'in', data.branches.ids),
                                                                             ('bsg_expirydate', '>', data.date_from),
                                                                             ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                                
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', 'in', data.branches.ids),
                                                                             ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                    
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                              
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.branch_id', 'in', data.branches.ids),
                                                                             ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if iqama_list:
                                sheet.write(row, col, 'Employee Tag', main_heading2)
                                sheet.write_string(row, col + 1, str(category_id.name), main_heading)
                                sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Department Name', main_heading2)
                                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 11, 'Job Position', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'كود الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_list:
                                    if iqama:
                                        total += 1
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                grand_total += total
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(total), main_heading)
                                row += 2
                    total = 0
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=',False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                        if iqama_ids:
                            sheet.write(row, col, 'Employee Tag', main_heading2)
                            sheet.write_string(row, col + 1, 'Undefined', main_heading)
                            sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                            row += 1
                            sheet.write(row, col, 'Employee ID', main_heading2)
                            sheet.write(row, col + 1, 'Employee Name', main_heading2)
                            sheet.write(row, col + 2, 'Department Name', main_heading2)
                            sheet.write(row, col + 3, 'Branch Name', main_heading2)
                            sheet.write(row, col + 4, 'Company Name', main_heading2)
                            sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                            sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                            sheet.write(row, col + 7, 'Issue Date', main_heading2)
                            sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                            sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                            sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                            sheet.write(row, col + 11, 'Job Position', main_heading2)
                            sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                            sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                            sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                            sheet.write(row, col + 15, 'Blood Group', main_heading2)
                            row += 1
                            sheet.write(row, col, 'كود الموظف', main_heading2)
                            sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                            sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                            sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                            sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                            sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                            sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                            sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                            sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                            sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                            sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                            sheet.write(row, col + 11, 'وظيفه', main_heading2)
                            sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                            sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                            sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                            sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                            row += 1
                            for iqama in iqama_ids:
                                if iqama:
                                    total += 1
                                    if iqama.bsg_issuedate:
                                        issue_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_issuedate)
                                        # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                        # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                        issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                            "%m/%d/%Y")
                                    else:
                                        issue_date_hijri_str = None
                                        issue_date_gregorian = None
                                    if iqama.bsg_arrivaldate:
                                        arrival_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_arrivaldate)
                                        # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                        # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                        arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                            "%m/%d/%Y")
                                    else:
                                        arrival_date_hijri_str = None
                                        arrival_date_gregorian = None
                                    if iqama.bsg_expirydate:
                                        expiry_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_expirydate)
                                        # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                        # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                        expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                            "%m/%d/%Y")
                                    else:
                                        expiry_date_hijri_str = None
                                        expiry_date_gregorian = None
                                    sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                       main_heading)
                                    sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                       main_heading)
                                    sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                       main_heading)
                                    sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 3,
                                                       str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                    sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                    sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                    sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                       main_heading)
                                    sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                       main_heading)
                                    row += 1
                            grand_total += total
                            sheet.write(row, col, 'Total', main_heading2)
                            sheet.write_string(row, col + 1, str(total), main_heading)
                            row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_job_position':
                if data.branches:
                    job_ids = []
                    iqamas = self.env['hr.iqama'].search([])
                    for iq in iqamas:
                        if iq.bsg_job_pos:
                            job_ids.append(iq.bsg_job_pos)
                    job_ids = list(set(job_ids))
                    grand_total=0
                    for job_id in job_ids:
                        if job_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Job Position', main_heading2)
                                sheet.write_string(row, col + 1, str(job_id), main_heading)
                                sheet.write(row, col + 2, 'وظيفه', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Department Name', main_heading2)
                                sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 5, 'Company Name', main_heading2)
                                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=',None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=',None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=',None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Job Position', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'وظيفه', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Department Name', main_heading2)
                        sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 5, 'Company Name', main_heading2)
                        sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date', main_heading2)
                        sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
        if data.mode == 'by_department':
            if data.grouping_by == 'all':
                sheet.write(row, col, 'Employee ID', main_heading2)
                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                sheet.write(row, col + 2, 'Department Name', main_heading2)
                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                sheet.write(row, col + 4, 'Company Name', main_heading2)
                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                sheet.write(row, col + 11, 'Job Position', main_heading2)
                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                row += 1
                sheet.write(row, col, 'كود الموظف', main_heading2)
                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                row += 1
                if data.department:
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                     ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                     ('bsg_employee.employee_state', '=', data.employee_state),
                                                                     ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '>', data.date_from),
                                                                         ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_expirydate', '!=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                            if data.employee_state == 'all':
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_expirydate', '=', None)])
                            else:
                                iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id','in',data.department.ids),
                                                                         ('bsg_employee.employee_state', '=',
                                                                          data.employee_state),
                                                                         ('bsg_expirydate', '=', None)])
                    if iqama_ids:
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
            if data.grouping_by == 'specific_guarantor':
                if data.department:
                    guarantor_ids = self.env['bsg.hr.guarantor'].search([])
                    grand_total=0
                    for guarantor_id in guarantor_ids:
                        if guarantor_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Guarantor Name', main_heading2)
                                sheet.write_string(row, col + 1, str(guarantor_id.name), main_heading)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Company Name', main_heading2)
                                sheet.write(row, col + 4, 'Department Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Guarantor Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Company Name', main_heading2)
                        sheet.write(row, col + 4, 'Department Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_branch':
                if data.department:
                    grand_total=0
                    branch_ids=self.env['bsg_branches.bsg_branches'].search([])
                    for branch_id in branch_ids:
                        if branch_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Branch Name', main_heading2)
                                sheet.write_string(row, col + 1, str(branch_id.branch_ar_name), main_heading)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 3, 'Company Name', main_heading2)
                                sheet.write(row, col + 4, 'Department Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.branch_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.branch_id', '=',None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=',None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=',None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=',None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Branch Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 3, 'Company Name', main_heading2)
                        sheet.write(row, col + 4, 'Department Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_department':
                if data.department:
                    grand_total=0
                    for department_id in data.department:
                        if department_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Department Name', main_heading2)
                                sheet.write_string(row, col + 1, str(department_id.complete_name), main_heading)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 3, 'Company Name', main_heading2)
                                sheet.write(row, col + 4, 'Branch Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 4, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',  None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Department Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 3, 'Company Name', main_heading2)
                        sheet.write(row, col + 4, 'Branch Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 4, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_company':
                if data.department:
                    company_ids = self.env['res.company'].search([])
                    grand_total = 0
                    for company_id in company_ids:
                        if company_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', 'in', data.branches.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total += iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Company Name', main_heading2)
                                sheet.write_string(row, col + 1, str(company_id.name), main_heading)
                                sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 3, 'Departement Name', main_heading2)
                                sheet.write(row, col + 4, 'Branch Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 4, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', 'in', data.branches.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Company Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 3, 'Departement Name', main_heading2)
                        sheet.write(row, col + 4, 'Branch Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 4, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col+ 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_employee_tag':
                if data.department:
                    category_ids = self.env['hr.employee.category'].search([])
                    grand_total = 0
                    for category_id in category_ids:
                        if category_id:
                            iqama_list=[]
                            total = 0
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                  
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', 'in', data.department.ids),('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', 'in', data.department.ids),
                                                                             ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                total += 1
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', 'in', data.department.ids),
                                                                             ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', 'in', data.department.ids),
                                                                             ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                                                                            
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', 'in', data.department.ids),
                                                                             ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', 'in', data.department.ids),
                                                                             ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', 'in', data.department.ids),
                                                                             ('bsg_expirydate', '>', data.date_from),
                                                                             ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', 'in', data.department.ids),
                                                                             ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.department_id', 'in', data.department.ids),
                                                                             ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if iqama_list:
                                sheet.write(row, col, 'Employee Tag', main_heading2)
                                sheet.write_string(row, col + 1, str(category_id.name), main_heading)
                                sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Department Name', main_heading2)
                                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 11, 'Job Position', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'كود الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_list:
                                    if iqama:
                                        total += 1
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                grand_total += total
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(total), main_heading)
                                row += 2
                    total=0
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', 'in', data.department.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if iqama_ids:
                        sheet.write(row, col, 'Employee Tag', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Department Name', main_heading2)
                        sheet.write(row, col + 3, 'Branch Name', main_heading2)
                        sheet.write(row, col + 4, 'Company Name', main_heading2)
                        sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date', main_heading2)
                        sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 11, 'Job Position', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 15, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'كود الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 11, 'وظيفه', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                total += 1
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        grand_total += total
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(total), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_job_position':
                if data.department:
                    job_ids = []
                    iqamas = self.env['hr.iqama'].search([])
                    for iq in iqamas:
                        if iq.bsg_job_pos:
                            job_ids.append(iq.bsg_job_pos)
                    job_ids = list(set(job_ids))
                    grand_total=0
                    for job_id in job_ids:
                        if job_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.department_id', 'in', data.department.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Job Position', main_heading2)
                                sheet.write_string(row, col + 1, str(job_id), main_heading)
                                sheet.write(row, col + 2, 'وظيفه', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Department Name', main_heading2)
                                sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 5, 'Company Name', main_heading2)
                                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.department_id', 'in', data.department.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Job Position', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'وظيفه', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Department Name', main_heading2)
                        sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 5, 'Company Name', main_heading2)
                        sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date', main_heading2)
                        sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
        if data.mode == 'by_employee_tag':
            if data.grouping_by == 'all':
                sheet.write(row, col, 'Employee ID', main_heading2)
                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                sheet.write(row, col + 2, 'Department Name', main_heading2)
                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                sheet.write(row, col + 4, 'Company Name', main_heading2)
                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                sheet.write(row, col + 11, 'Job Position', main_heading2)
                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                row += 1
                sheet.write(row, col, 'كود الموظف', main_heading2)
                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                row += 1
                if data.employee_tag:
                    duplicate_iqama_list=[]
                    for employee_tag_id in data.employee_tag:
                        if employee_tag_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.employee_state', '=', data.employee_state)])                               
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.employee_state', '=', data.employee_state),
                                                                             ('bsg_expirydate', '=', data.expiry_date)])                                                                             
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '!=', data.expiry_date)])                                                                                
                                else:
                                    iqama_ids = self.env['hr.iqama'].search([ ('bsg_employee.employee_state', '=',
                                                                              data.employee_state),
                                                                             ('bsg_expirydate', '!=', data.expiry_date)])                                                                               
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '>', data.expiry_date)])                                                                                 
                                else:
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.employee_state', '=',
                                                                              data.employee_state),
                                                                             ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([ ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.employee_state', '=',
                                                                              data.employee_state),
                                                                             ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.employee_state', '=',
                                                                              data.employee_state),
                                                                             ('bsg_expirydate', '>=', data.expiry_date)])                                                                                 
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '<=', data.expiry_date)])                                                                                 
                                else:
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.employee_state', '=',
                                                                              data.employee_state),
                                                                             ('bsg_expirydate', '<=', data.expiry_date)])                                                                               
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '>', data.date_from),
                                                                             ('bsg_expirydate', '<', data.date_to)])                                                                                 
                                else:
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.employee_state', '=',
                                                                              data.employee_state),
                                                                             ('bsg_expirydate', '>', data.date_from),
                                                                             ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.employee_state', '=',
                                                                              data.employee_state),
                                                                             ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.employee_state', '=',
                                                                              data.employee_state),
                                                                             ('bsg_expirydate', '=', None)])
                            if iqama_ids:
                                for iqama in iqama_ids:
                                    if iqama:
                                        if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                            if iqama.bsg_issuedate:
                                                issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                                # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                                # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                                issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                            else:
                                                issue_date_hijri_str = None
                                                issue_date_gregorian = None
                                            if iqama.bsg_arrivaldate:
                                                arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                    iqama.bsg_arrivaldate)
                                                # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                                # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                                arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                            else:
                                                arrival_date_hijri_str = None
                                                arrival_date_gregorian = None
                                            if iqama.bsg_expirydate:
                                                expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                    iqama.bsg_expirydate)
                                                # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                                # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                                expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                            else:
                                                expiry_date_hijri_str = None
                                                expiry_date_gregorian = None
                                            sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                               main_heading)
                                            sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                               main_heading)
                                            sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                               main_heading)
                                            sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                               main_heading)
                                            sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                               main_heading)
                                            sheet.write_string(row, col + 3,
                                                               str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                               main_heading)
                                            sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                               main_heading)
                                            sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                               main_heading)
                                            sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                               main_heading)
                                            sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                            sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                            sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                               main_heading)
                                            sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                               main_heading)
                                            sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                            sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                               main_heading)
                                            sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                               main_heading)
                                            sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                               main_heading)
                                            sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                               main_heading)
                                            duplicate_iqama_list.append(iqama.id)
                                            row += 1
            if data.grouping_by == 'specific_guarantor':
                if data.employee_tag:
                    guarantor_ids = self.env['bsg.hr.guarantor'].search([])
                    grand_total=0
                    for guarantor_id in guarantor_ids:
                        if guarantor_id:
                            iqama_list=[]
                            duplicate_iqama_list=[]
                            total=0
                            for employee_tag_id in data.employee_tag:
                                if employee_tag_id:
                                    if data.expire_date_condition == 'all':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id)])                                            
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:                                 
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_not_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '!=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_after':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '>', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '>', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_before':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '<', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '<', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_after_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '>=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_before_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '<=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_between':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '!=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '!=', None),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_not_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('guarantor_id', '=', guarantor_id.id),
                                                 ('bsg_expirydate', '=', None),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)                                                        
                            if iqama_list:
                                sheet.write(row, col, 'Guarantor Name', main_heading2)
                                sheet.write_string(row, col + 1,str(guarantor_id.name), main_heading)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Department Name', main_heading2)
                                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_list:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        total += 1
                                        row += 1                                        
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(total), main_heading)
                                grand_total+=total
                                row += 2
                    iqama_list = []
                    duplicate_iqama_list = []
                    total = 0
                    for employee_tag_id in data.employee_tag:
                        if employee_tag_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=',None),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', None),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                    if iqama_list:
                        sheet.write(row, col, 'Guarantor Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Department Name', main_heading2)
                        sheet.write(row, col + 3, 'Branch Name', main_heading2)
                        sheet.write(row, col + 4, 'Company Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_list:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                total += 1
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(total), main_heading)
                        grand_total += total
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_branch':
                if data.employee_tag:
                    grand_total=0
                    branch_ids=self.env['bsg_branches.bsg_branches'].search([])
                    for branch_id in branch_ids:
                        if branch_id:
                            iqama_list=[]
                            duplicate_iqama_list = []
                            total=0
                            for employee_tag_id in data.employee_tag:
                                if employee_tag_id:
                                    if data.expire_date_condition == 'all':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_not_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '!=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_after':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '>', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '>', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_before':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '<', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '<', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_after_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '>=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_before_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '<=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_between':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '!=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '!=', None),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_not_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.branch_id', '=', branch_id.id),
                                                 ('bsg_expirydate', '=', None),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                            if iqama_list:
                                sheet.write(row, col, 'Branch Name', main_heading2)
                                sheet.write_string(row, col + 1, str(branch_id.branch_ar_name), main_heading)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 3, 'Company Name', main_heading2)
                                sheet.write(row, col + 4, 'Department Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_list:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        total += 1
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(total), main_heading)
                                grand_total += total
                                row += 2
                    iqama_list = []
                    duplicate_iqama_list = []
                    total = 0
                    for employee_tag_id in data.employee_tag:
                        if employee_tag_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=',None),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=',None),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=',None),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=',None),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', None),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                    if iqama_list:
                        sheet.write(row, col, 'Branch Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 3, 'Company Name', main_heading2)
                        sheet.write(row, col + 4, 'Department Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_list:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                total += 1
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(total), main_heading)
                        grand_total += total
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_department':
                if data.employee_tag:
                    grand_total=0
                    department_ids=self.env['hr.department'].search([])
                    for department_id in department_ids:
                        if department_id:
                            iqama_list=[]
                            duplicate_iqama_list = []
                            total=0
                            for employee_tag_id in data.employee_tag:
                                if employee_tag_id:
                                    if data.expire_date_condition == 'all':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_not_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '!=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_after':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '>', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '>', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_before':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '<', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '<', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_after_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '>=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_before_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '<=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_between':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '!=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '!=', None),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_not_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.department_id', '=', department_id.id),
                                                 ('bsg_expirydate', '=', None),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                            if iqama_list:
                                sheet.write(row, col, 'Department Name', main_heading2)
                                sheet.write_string(row, col + 1, str(department_id.complete_name), main_heading)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_list:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        total += 1
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(total), main_heading)
                                grand_total += total
                                row += 2                        
                    iqama_list = []  
                    duplicate_iqama_list = []
                    total = 0
                    for employee_tag_id in data.employee_tag:
                        if employee_tag_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', None),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                    if iqama_list:
                        sheet.write(row, col, 'Department Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 4, 'Company Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_list:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                total += 1
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(total), main_heading)
                        grand_total += total
                        row += 2                    
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_company':
                if data.employee_tag:
                    grand_total=0
                    company_ids=self.env['res.company'].search([])
                    for company_id in company_ids:
                        if company_id:
                            iqama_list=[]
                            duplicate_iqama_list = []
                            total=0
                            for employee_tag_id in data.employee_tag:
                                if employee_tag_id:
                                    if data.expire_date_condition == 'all':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_not_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '!=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_after':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '>', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '>', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_before':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '<', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '<', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_after_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '>=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_before_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '<=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_between':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '!=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '!=', None),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_not_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_employee.company_id', '=', company_id.id),
                                                 ('bsg_expirydate', '=', None),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                            if iqama_list:
                                sheet.write(row, col, 'Company Name', main_heading2)
                                sheet.write_string(row, col + 1, str(company_id.name), main_heading)
                                sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 3, 'Departement Name', main_heading2)
                                sheet.write(row, col + 4, 'Branch Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 4, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_list:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        total += 1
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(total), main_heading)
                                grand_total += total
                                row += 2                           
                    iqama_list=[]
                    duplicate_iqama_list = []
                    total = 0
                    for employee_tag_id in data.employee_tag:
                        if employee_tag_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=',None),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', None),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                    if iqama_list:
                        sheet.write(row, col, 'Company Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 3, 'Departement Name', main_heading2)
                        sheet.write(row, col + 4, 'Branch Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 4, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_list:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                total += 1
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(total), main_heading)
                        grand_total += total
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_employee_tag':
                if data.employee_tag:
                    grand_total = 0
                    for employee_tag_id in data.employee_tag:
                        if employee_tag_id:
                            total = 0
                            iqama_list=[]                           
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.employee_state', '=', data.employee_state)])                                         
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                    
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '!=', data.expiry_date)])                                                                            
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                                         
                                if iqama_ids:                                    
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '>', data.expiry_date)])                                                                            
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                                        
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([ ('bsg_expirydate', '<', data.expiry_date)])                                                                            
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                                        
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '>=', data.expiry_date)])                                                                             
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                                         
                                if iqama_ids:                                    
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '<=', data.expiry_date)])                                                                            
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                                         
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '>', data.date_from),
                                                                             ('bsg_expirydate', '<', data.date_to)])                                                                            
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                                         
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '!=', None)])                                                                             
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_expirydate', '!=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                                         
                                if iqama_ids:                                    
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_expirydate', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])                                         
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if iqama_list:
                                sheet.write(row, col, 'Employee Tag', main_heading2)
                                sheet.write_string(row, col + 1, str(employee_tag_id.name), main_heading)
                                sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Department Name', main_heading2)
                                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 11, 'Job Position', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'كود الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_list:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        total += 1
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(total), main_heading)
                                grand_total += total
                                row += 2               
                    total = 0
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.employee_state', '=', data.employee_state),('bsg_employee.category_ids', '=', False)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '=', data.expiry_date),('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_expirydate', '=', data.expiry_date),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '!=', data.expiry_date),('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_expirydate', '!=', data.expiry_date),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '>', data.expiry_date),('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_expirydate', '>', data.expiry_date),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '<', data.expiry_date),('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_expirydate', '<', data.expiry_date),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '>=', data.expiry_date),('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_expirydate', '>=', data.expiry_date),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '<=', data.expiry_date),('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_expirydate', '<=', data.expiry_date),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '>', data.date_from),('bsg_employee.category_ids', '=', False),
                                                                     ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '!=', None),('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_expirydate', '!=', None),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_expirydate', '=', None),('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_expirydate', '=', None),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if iqama_ids:
                        sheet.write(row, col, 'Employee Tag', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Department Name', main_heading2)
                        sheet.write(row, col + 3, 'Branch Name', main_heading2)
                        sheet.write(row, col + 4, 'Company Name', main_heading2)
                        sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date', main_heading2)
                        sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 11, 'Job Position', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 15, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'كود الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 11, 'وظيفه', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                total += 1
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        grand_total += total
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(total), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_job_position':
                if data.employee_tag:
                    grand_total=0
                    job_ids = []
                    iqamas = self.env['hr.iqama'].search([])
                    for iq in iqamas:
                        if iq.bsg_job_pos:
                            job_ids.append(iq.bsg_job_pos)
                    job_ids = list(set(job_ids))
                    for job_id in job_ids:
                        if job_id:
                            iqama_list=[]
                            duplicate_iqama_list = []
                            total=0
                            for employee_tag_id in data.employee_tag:
                                if employee_tag_id:
                                    if data.expire_date_condition == 'all':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_not_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '!=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '!=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_after':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '>', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '>', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_before':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '<', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '<', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_after_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '>=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '>=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_before_or_equal_to':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '<=', data.expiry_date)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '<=', data.expiry_date),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_between':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '>', data.date_from),
                                                 ('bsg_expirydate', '<', data.date_to),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '!=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '!=', None),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                                    if data.expire_date_condition == 'is_not_set':
                                        if data.employee_state == 'all':
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '=', None)])
                                        else:
                                            iqama_ids = self.env['hr.iqama'].search(
                                                [('bsg_job_pos', '=', job_id),
                                                 ('bsg_expirydate', '=', None),
                                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                                        if iqama_ids:
                                            for iqama in iqama_ids:
                                                if iqama:
                                                    if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                        iqama_list.append(iqama)
                                                        duplicate_iqama_list.append(iqama.id)
                            if iqama_list:
                                sheet.write(row, col, 'Job Position', main_heading2)
                                sheet.write_string(row, col + 1, str(job_id), main_heading)
                                sheet.write(row, col + 2, 'وظيفه', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Department Name', main_heading2)
                                sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 5, 'Company Name', main_heading2)
                                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_list:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        total += 1
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(total), main_heading)
                                grand_total += total
                                row += 2                        
                    iqama_list = []  
                    duplicate_iqama_list = []
                    total = 0
                    for employee_tag_id in data.employee_tag:
                        if employee_tag_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', None),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if employee_tag_id in iqama.bsg_employee.category_ids and iqama.id not in duplicate_iqama_list:
                                                iqama_list.append(iqama)
                                                duplicate_iqama_list.append(iqama.id)
                    if iqama_list:
                        sheet.write(row, col, 'Job Position', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'وظيفه', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Department Name', main_heading2)
                        sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 5, 'Company Name', main_heading2)
                        sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date', main_heading2)
                        sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_list:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                total += 1
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(total), main_heading)
                        grand_total += total
                        row += 2                    
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
        if data.mode == 'by_company':
            if data.grouping_by == 'all':
                sheet.write(row, col, 'Employee ID', main_heading2)
                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                sheet.write(row, col + 2, 'Department Name', main_heading2)
                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                sheet.write(row, col + 4, 'Company Name', main_heading2)
                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                sheet.write(row, col + 11, 'Job Position', main_heading2)
                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                row += 1
                sheet.write(row, col, 'كود الموظف', main_heading2)
                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                row += 1
                if data.company:
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_employee.employee_state', '=', data.employee_state),
                                                                     ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_employee.employee_state', '=',
                                                                      data.employee_state),
                                                                     ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_employee.employee_state', '=',
                                                                      data.employee_state),
                                                                     ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_employee.employee_state', '=',
                                                                      data.employee_state),
                                                                     ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_employee.employee_state', '=',
                                                                      data.employee_state),
                                                                     ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_employee.employee_state', '=',
                                                                      data.employee_state),
                                                                     ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_expirydate', '>', data.date_from),
                                                                     ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_employee.employee_state', '=',
                                                                      data.employee_state),
                                                                     ('bsg_expirydate', '>', data.date_from),
                                                                     ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_employee.employee_state', '=',
                                                                      data.employee_state),
                                                                     ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id','in',data.company.ids),
                                                                     ('bsg_employee.employee_state', '=',
                                                                      data.employee_state),
                                                                     ('bsg_expirydate', '=', None)])
                    if iqama_ids:
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
            if data.grouping_by == 'specific_guarantor':
                if data.company:
                    guarantor_ids = self.env['bsg.hr.guarantor'].search([])
                    grand_total=0
                    for guarantor_id in guarantor_ids:
                        if guarantor_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('guarantor_id', '=', guarantor_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Guarantor Name', main_heading2)
                                sheet.write_string(row, col + 1, str(guarantor_id.name), main_heading)
                                sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Company Name', main_heading2)
                                sheet.write(row, col + 4, 'Department Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=',None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('guarantor_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                        grand_total += iqama_count
                        if iqama_ids:
                            sheet.write(row, col, 'Guarantor Name', main_heading2)
                            sheet.write_string(row, col + 1, 'Undefined', main_heading)
                            sheet.write(row, col + 2, 'اسم الضامن', main_heading2)
                            row += 1
                            sheet.write(row, col, 'Employee ID', main_heading2)
                            sheet.write(row, col + 1, 'Employee Name', main_heading2)
                            sheet.write(row, col + 2, 'Branch Name', main_heading2)
                            sheet.write(row, col + 3, 'Company Name', main_heading2)
                            sheet.write(row, col + 4, 'Department Name', main_heading2)
                            sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                            sheet.write(row, col + 6, 'Issue Date', main_heading2)
                            sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                            sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                            sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                            sheet.write(row, col + 10, 'Job Position', main_heading2)
                            sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                            sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                            sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                            sheet.write(row, col + 14, 'Blood Group', main_heading2)
                            row += 1
                            sheet.write(row, col, 'هوية الموظف', main_heading2)
                            sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                            sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                            sheet.write(row, col + 3, 'اسم الشركة', main_heading2)
                            sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                            sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                            sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                            sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                            sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                            sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                            sheet.write(row, col + 10, 'وظيفه', main_heading2)
                            sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                            sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                            sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                            sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                            row += 1
                            for iqama in iqama_ids:
                                if iqama:
                                    if iqama.bsg_issuedate:
                                        issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                        # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                        # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                        issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                    else:
                                        issue_date_hijri_str = None
                                        issue_date_gregorian = None
                                    if iqama.bsg_arrivaldate:
                                        arrival_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_arrivaldate)
                                        # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                        # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                        arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                    else:
                                        arrival_date_hijri_str = None
                                        arrival_date_gregorian = None
                                    if iqama.bsg_expirydate:
                                        expiry_date_hijri_str = HijriDate.get_hijri_date(
                                            iqama.bsg_expirydate)
                                        # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                        # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                        expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                    else:
                                        expiry_date_hijri_str = None
                                        expiry_date_gregorian = None
                                    sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                       main_heading)
                                    sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 2,
                                                       str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 3, str(iqama.bsg_employee.company_id.name),
                                                       main_heading)
                                    sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                       main_heading)
                                    sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                    sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                    sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                    sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                       main_heading)
                                    sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                       main_heading)
                                    sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                       main_heading)
                                    sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                       main_heading)
                                    row += 1
                            sheet.write(row, col, 'Total', main_heading2)
                            sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                            row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_branch':
                if data.company:
                    grand_total=0
                    branch_ids=self.env['bsg_branches.bsg_branches'].search([])
                    for branch_id in branch_ids:
                        if branch_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.branch_id', '=', branch_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.branch_id', '=', branch_id.id), (
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.branch_id', '=', branch_id.id),(
                                            'bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Branch Name', main_heading2)
                                sheet.write_string(row, col + 1, str(branch_id.branch_ar_name), main_heading)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Department Name', main_heading2)
                                sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.branch_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.branch_id', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=',None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=',None),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=',None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=',None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=',None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=', None),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.branch_id', '=', None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.branch_id', '=',None), (
                                    'bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Branch Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Department Name', main_heading2)
                        sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 4, 'Company Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_department':
                if data.company:
                    grand_total=0
                    department_ids = self.env['hr.department'].search([])
                    for department_id in department_ids:
                        if department_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_employee.department_id', '=', department_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Department Name', main_heading2)
                                sheet.write_string(row, col + 1, str(department_id.complete_name), main_heading)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',None),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',None),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=',None),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.department_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.department_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Department Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 4, 'Company Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_company':
                if data.company:
                    grand_total = 0
                    for company_id in data.company:
                        if company_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=',company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=',company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [ ('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                                    iqama_count = self.env['hr.iqama'].search_count(
                                        [('bsg_employee.company_id', '=', company_id.id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None)])
                            grand_total += iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Company Name', main_heading2)
                                sheet.write_string(row, col + 1, str(company_id.name), main_heading)
                                sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 4, 'Department Name', main_heading2)
                                sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 6, 'Issue Date', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 10, 'Job Position', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 10, 'وظيفه', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=',None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=',None),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=',None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_employee.company_id', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Company Name', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'اسم الشركة', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 4, 'Department Name', main_heading2)
                        sheet.write(row, col + 5, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 6, 'Issue Date', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 8, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 10, 'Job Position', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 4, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 5, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 6, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 10, 'وظيفه', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 8, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col+ 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_employee_tag':
                if data.company:
                    category_ids = self.env['hr.employee.category'].search([])
                    grand_total = 0
                    for category_id in category_ids:
                        if category_id:
                            total = 0
                            iqama_list=[]
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                                                                               
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', 'in', data.company.ids),('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),('bsg_expirydate', '=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                    
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                                
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', 'in', data.company.ids),
                                                                             ('bsg_expirydate', '!=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                    
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', 'in', data.company.ids),
                                                                             ('bsg_expirydate', '>', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', 'in', data.company.ids),
                                                                             ('bsg_expirydate', '<', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', 'in', data.company.ids),
                                                                             ('bsg_expirydate', '>=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                    
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                                
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', 'in', data.company.ids),
                                                                             ('bsg_expirydate', '<=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                                
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', 'in', data.company.ids),
                                                                             ('bsg_expirydate', '>', data.date_from),
                                                                             ('bsg_expirydate', '<', data.date_to)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                                
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', 'in', data.company.ids),
                                                                             ('bsg_expirydate', '!=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                    
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                                
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search([('bsg_employee.company_id', 'in', data.company.ids),
                                                                             ('bsg_expirydate', '=', None)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                if iqama_ids:                                   
                                    for iqama in iqama_ids:
                                        if iqama:
                                            if category_id in iqama.bsg_employee.category_ids:
                                                iqama_list.append(iqama)                                               
                            if iqama_list:
                                sheet.write(row, col, 'Employee Tag', main_heading2)
                                sheet.write_string(row, col + 1, str(category_id.name), main_heading)
                                sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Department Name', main_heading2)
                                sheet.write(row, col + 3, 'Branch Name', main_heading2)
                                sheet.write(row, col + 4, 'Company Name', main_heading2)
                                sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 11, 'Job Position', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 15, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'كود الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 11, 'وظيفه', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_list:
                                    if iqama:
                                        total += 1
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                                "%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                grand_total += total
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(total), main_heading)
                                row += 2
                    total = 0
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', None)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_employee.company_id', 'in', data.company.ids),('bsg_employee.category_ids', '=', False),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if iqama_ids:
                        sheet.write(row, col, 'Employee Tag', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col + 2, 'علامة الموظف', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Department Name', main_heading2)
                        sheet.write(row, col + 3, 'Branch Name', main_heading2)
                        sheet.write(row, col + 4, 'Company Name', main_heading2)
                        sheet.write(row, col + 5, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date', main_heading2)
                        sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 11, 'Job Position', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 13, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 14, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 15, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'كود الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 3, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 4, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 5, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 11, 'وظيفه', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 13, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 14, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 15, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                total += 1
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime(
                                        "%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(iqama.bsg_job_pos), main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 15, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        grand_total += total
                        sheet.write(row, col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(total), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)
            if data.grouping_by == 'by_job_position':
                if data.company:
                    grand_total=0
                    job_ids = []
                    iqamas = self.env['hr.iqama'].search([])
                    for iq in iqamas:
                        if iq.bsg_job_pos:
                            job_ids.append(iq.bsg_job_pos)
                    job_ids = list(set(job_ids))
                    for job_id in job_ids:
                        if job_id:
                            if data.expire_date_condition == 'all':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state)])
                            if data.expire_date_condition == 'is_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', data.expiry_date)])
                            if data.expire_date_condition == 'is_not_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.company_id', 'in', data.company.ids),
                                         ('bsg_expirydate', '!=', data.expiry_date)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_after':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_before':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_after_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_before_or_equal_to':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '<=', data.expiry_date),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_between':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '>', data.date_from),
                                         ('bsg_expirydate', '<', data.date_to),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', None)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '!=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            if data.expire_date_condition == 'is_not_set':
                                if data.employee_state == 'all':
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                else:
                                    iqama_ids = self.env['hr.iqama'].search(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                                    iqama_count=self.env['hr.iqama'].search_count(
                                        [('bsg_job_pos', '=', job_id),
                                         ('bsg_employee.employee_state', '=', data.employee_state),
                                         ('bsg_expirydate', '=', None),
                                         ('bsg_employee.company_id', 'in', data.company.ids)])
                            grand_total+=iqama_count
                            if iqama_ids:
                                sheet.write(row, col, 'Job Position', main_heading2)
                                sheet.write_string(row, col + 1, str(job_id), main_heading)
                                sheet.write(row, col + 2, 'وظيفه', main_heading2)
                                row += 1
                                sheet.write(row, col, 'Employee ID', main_heading2)
                                sheet.write(row, col + 1, 'Employee Name', main_heading2)
                                sheet.write(row, col + 2, 'Branch Name', main_heading2)
                                sheet.write(row, col + 3, 'Department Name', main_heading2)
                                sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                                sheet.write(row, col + 5, 'Company Name', main_heading2)
                                sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                                sheet.write(row, col + 7, 'Issue Date', main_heading2)
                                sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                                sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                                sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                                sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                                sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                                sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                                sheet.write(row, col + 14, 'Blood Group', main_heading2)
                                row += 1
                                sheet.write(row, col, 'هوية الموظف', main_heading2)
                                sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                                sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                                sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                                sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                                sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                                sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                                sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                                sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                                sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                                sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                                sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                                sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                                sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                                sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                                row += 1
                                for iqama in iqama_ids:
                                    if iqama:
                                        if iqama.bsg_issuedate:
                                            issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                            # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                            # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                            issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                        else:
                                            issue_date_hijri_str = None
                                            issue_date_gregorian = None
                                        if iqama.bsg_arrivaldate:
                                            arrival_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_arrivaldate)
                                            # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                            # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                            arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                        else:
                                            arrival_date_hijri_str = None
                                            arrival_date_gregorian = None
                                        if iqama.bsg_expirydate:
                                            expiry_date_hijri_str = HijriDate.get_hijri_date(
                                                iqama.bsg_expirydate)
                                            # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                            # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                            expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                        else:
                                            expiry_date_hijri_str = None
                                            expiry_date_gregorian = None
                                        sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                           main_heading)
                                        sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 2,
                                                           str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                           main_heading)
                                        sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                           main_heading)
                                        sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                        sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                        sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                           main_heading)
                                        sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                           main_heading)
                                        sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                           main_heading)
                                        sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                           main_heading)
                                        row += 1
                                sheet.write(row, col, 'Total', main_heading2)
                                sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                                row += 2
                    if data.expire_date_condition == 'all':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state)])
                    if data.expire_date_condition == 'is_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', data.expiry_date)])
                    if data.expire_date_condition == 'is_not_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids),
                                 ('bsg_expirydate', '!=', data.expiry_date)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_after':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_before':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_after_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=',None),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_before_or_equal_to':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '<=', data.expiry_date),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_between':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '>', data.date_from),
                                 ('bsg_expirydate', '<', data.date_to),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '!=', None)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '!=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    if data.expire_date_condition == 'is_not_set':
                        if data.employee_state == 'all':
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=',None),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=',None),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                        else:
                            iqama_ids = self.env['hr.iqama'].search(
                                [('bsg_job_pos', '=',None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                            iqama_count = self.env['hr.iqama'].search_count(
                                [('bsg_job_pos', '=', None),
                                 ('bsg_employee.employee_state', '=', data.employee_state),
                                 ('bsg_expirydate', '=', None),
                                 ('bsg_employee.company_id', 'in', data.company.ids)])
                    grand_total += iqama_count
                    if iqama_ids:
                        sheet.write(row, col, 'Job Position', main_heading2)
                        sheet.write_string(row, col + 1, 'Undefined', main_heading)
                        sheet.write(row, col+2, 'وظيفه', main_heading2)
                        row += 1
                        sheet.write(row, col, 'Employee ID', main_heading2)
                        sheet.write(row, col + 1, 'Employee Name', main_heading2)
                        sheet.write(row, col + 2, 'Branch Name', main_heading2)
                        sheet.write(row, col + 3, 'Department Name', main_heading2)
                        sheet.write(row, col + 4, 'Guarantor Name', main_heading2)
                        sheet.write(row, col + 5, 'Company Name', main_heading2)
                        sheet.write(row, col + 6, 'Iqama ID NO', main_heading2)
                        sheet.write(row, col + 7, 'Issue Date', main_heading2)
                        sheet.write(row, col + 8, 'Issue Date Hijri', main_heading2)
                        sheet.write(row, col + 9, 'Expiry Date', main_heading2)
                        sheet.write(row, col + 10, 'Expiry Date Hijri', main_heading2)
                        sheet.write(row, col + 11, 'Arrival Date in Saudi', main_heading2)
                        sheet.write(row, col + 12, 'Arrival Date in Saudi Hijri', main_heading2)
                        sheet.write(row, col + 13, 'Place Of Issue', main_heading2)
                        sheet.write(row, col + 14, 'Blood Group', main_heading2)
                        row += 1
                        sheet.write(row, col, 'هوية الموظف', main_heading2)
                        sheet.write(row, col + 1, 'اسم الموظف', main_heading2)
                        sheet.write(row, col + 2, 'اسم الفرع', main_heading2)
                        sheet.write(row, col + 3, 'اسم القسم', main_heading2)
                        sheet.write(row, col + 4, 'اسم الضامن', main_heading2)
                        sheet.write(row, col + 5, 'اسم الشركة', main_heading2)
                        sheet.write(row, col + 6, 'معرف الإقامة', main_heading2)
                        sheet.write(row, col + 7, 'تاريخ الاصدار', main_heading2)
                        sheet.write(row, col + 8, 'تاريخ الإصدار الهجري', main_heading2)
                        sheet.write(row, col + 9, 'تاريخ الانتهاء', main_heading2)
                        sheet.write(row, col + 10, 'تاريخ الانتهاء هجري', main_heading2)
                        sheet.write(row, col + 11, 'تاريخ الوصول إلى السعودية', main_heading2)
                        sheet.write(row, col + 12, 'تاريخ الوصول إلى الهجري السعودي', main_heading2)
                        sheet.write(row, col + 13, 'مكان صدوره', main_heading2)
                        sheet.write(row, col + 14, 'فصيلة الدم', main_heading2)
                        row += 1
                        for iqama in iqama_ids:
                            if iqama:
                                if iqama.bsg_issuedate:
                                    issue_date_hijri_str = HijriDate.get_hijri_date(iqama.bsg_issuedate)
                                    # issue_date_hijri_obj = datetime.strptime(issue_date_hijri_str,'%Y-%m-%d')
                                    # issue_date_hijri = issue_date_hijri_obj.strftime("%m/%d/%Y")
                                    issue_date_gregorian = iqama.bsg_issuedate.strftime("%m/%d/%Y")
                                else:
                                    issue_date_hijri_str = None
                                    issue_date_gregorian = None
                                if iqama.bsg_arrivaldate:
                                    arrival_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_arrivaldate)
                                    # arrival_date_hijri_obj = datetime.strptime(arrival_date_hijri_str, '%Y-%m-%d')
                                    # arrival_date_hijri = arrival_date_hijri_obj.strftime("%m/%d/%Y")
                                    arrival_date_gregorian = iqama.bsg_arrivaldate.strftime("%m/%d/%Y")
                                else:
                                    arrival_date_hijri_str = None
                                    arrival_date_gregorian = None
                                if iqama.bsg_expirydate:
                                    expiry_date_hijri_str = HijriDate.get_hijri_date(
                                        iqama.bsg_expirydate)
                                    # expiry_date_hijri_obj = datetime.strptime(expiry_date_hijri_str, '%Y-%m-%d')
                                    # expiry_date_hijri = expiry_date_hijri_obj.strftime("%m/%d/%Y")
                                    expiry_date_gregorian = iqama.bsg_expirydate.strftime("%m/%d/%Y")
                                else:
                                    expiry_date_hijri_str = None
                                    expiry_date_gregorian = None
                                sheet.write_string(row, col, str(iqama.bsg_employee.driver_code),
                                                   main_heading)
                                sheet.write_string(row, col + 1, str(iqama.bsg_employee.name),
                                                   main_heading)
                                sheet.write_string(row, col + 2,
                                                   str(iqama.bsg_employee.branch_id.branch_ar_name),
                                                   main_heading)
                                sheet.write_string(row, col + 3, str(iqama.bsg_employee.department_id.complete_name),
                                                   main_heading)
                                sheet.write_string(row, col + 4, str(iqama.guarantor_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 5, str(iqama.bsg_employee.company_id.name),
                                                   main_heading)
                                sheet.write_string(row, col + 6, str(iqama.bsg_iqama_name),
                                                   main_heading)
                                sheet.write_string(row, col + 7, str(issue_date_gregorian), main_heading)
                                sheet.write_string(row, col + 8, str(issue_date_hijri_str), main_heading)
                                sheet.write_string(row, col + 9, str(expiry_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 10, str(expiry_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 11, str(arrival_date_gregorian),
                                                   main_heading)
                                sheet.write_string(row, col + 12, str(arrival_date_hijri_str),
                                                   main_heading)
                                sheet.write_string(row, col + 13, str(iqama.bsg_placeofissue),
                                                   main_heading)
                                sheet.write_string(row, col + 14, str(iqama.bsg_bloodgroup),
                                                   main_heading)
                                row += 1
                        sheet.write(row,col, 'Total', main_heading2)
                        sheet.write_string(row, col + 1, str(iqama_count), main_heading)
                        row += 2
                    sheet.write(row, col, 'Grand Total', main_heading2)
                    sheet.write_string(row, col + 1, str(grand_total), main_heading)















































































